<!doctype html>
<title>Title</title>
<link rel='stylesheet' href='styles/skeleton/skeleton.css'>
<link rel='stylesheet' href='styles/skeleton/normalize.css'>
<script src='/js/vendor/mithril.js'></script>

<div id='venue_search'></div>
<div id='venue_playlist'></div>

<script>
// console log function for logging results of ajax requests
var log = function (value) {
  console.log(value)
}

var vm = {
  view: m.prop('search'),
  venues: m.prop([]),
  artist_profiles: m.prop([])
}


function VenueCtrl () {
  var ctrl = {
    searchForVenue: function searchForVenue (e) {
      e.preventDefault();
      m.request({
        url: '/venues/search',
        method: 'POST',
        data: { venue: e.currentTarget.venue.value }
      }).then(vm.venues)
    },
    getVenuePlaylist: function (venue, e) {
      e.preventDefault();
      m.request({
        url: '/venues/' + venue.id,
        method: 'GET'
      }).then(vm.artist_profiles).then(vm.view.bind(null, 'playlist'))
    }
  }
  return ctrl
}

var venueSearchResult = function (ctrl, v) {
  return [
    m('.venue_search_result', [
      m('div', [
        m('a', {
          onclick: ctrl.getVenuePlaylist.bind(null, v),
          href: '#'
        }, v.name)
      ]),
      m('a', {href: v.website}, 'Venue website'),
      m('br'),
      v.address
    ]),
    m('br')
  ]
}

function venueSearchView (ctrl) {
  if (vm.view() !== 'search') return null

  var results = vm.venues().map(venueSearchResult.bind(null, ctrl));

  return [
    m('form', { onsubmit: ctrl.searchForVenue },  [  // revisit 12/17
      m('input[name=venue]')
    ]),
    m('br'),
    results
  ]
}

/////
Playlist = {}
Playlist.controller = function () {}

var artistTrack = function (track) {
  return [
    m('a', {
      href: track.url,
      target: '_blank'
    }, track.name),
    m('br')
  ]
}

var playlistItem = function (artist_profile) {
  var tracks = artist_profile.tracks.map(artistTrack);

  return [
    m('.playlist_item', [
      artist_profile.name,
      m('br'),
      tracks,
      m('br')
    ])
  ]
}

Playlist.view = function (ctrl) {
  var profiles = vm.artist_profiles().map(playlistItem);

  return profiles
}
// <--


m.module(document.getElementById('venue_search'), { controller: VenueCtrl, view: venueSearchView })
m.module(document.getElementById('venue_playlist'), Playlist)

</script>
